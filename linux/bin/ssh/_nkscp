#!/bin/sh
TMPFILE=`mktemp`

#CMD_SCP='scp '
CMD_SCP='/opt/framework/bin/scp -J arkoon69! '
FORCE_ROOT=no
case X$1 in
    "X-r")
	    FORCE_ROOT=yes
		shift
		;;
	"X-n")
		CMD_SCP='scp '
		shift
		;;
	"X-f")
		CMD_SCP='/opt/framework/bin/scp -J arkoon69! '
		shift
		;;
esac

_nkremote.sh $1 > $TMPFILE
[ $? -ne 0 ] && cat $TMPFILE && exit 1

read P U MACH < $TMPFILE
rm -f $TMPFILE
[ "$FORCE_ROOT" == "yes" ] && U="root"

ARGS=
DEST=
ORIG=

shift
for A in $*
do
	if [ `expr "$A" : "@"` == 1 ]
	then
		A=`echo $A | sed s/^@//`
		ARGS=" ${ARGS} ${U}@${MACH}:$A "
		DEST=ok
	else
		ARGS=" ${ARGS} ${A} "
		ORIG=1
	fi
done

if [ -z "$DEST" -a -z "$ORIG" ]
then
	echo "Usage `basename $0`: (IP | MACHINE_NAME) ( files | @files )"
	exit 1
fi


[ -z "$DEST" ] && ARGS=" ${ARGS} ${U}@${MACH}:/tmp "
[ -z "$ORIG" ] && ARGS=" ${ARGS} . "

EXEC="$CMD_SCP  -P$P $ARGS"
echo "$EXEC"
$EXEC
if [ $? -eq 255 -o $? -eq 1 ]; then
  $EXEC 2>&1 | grep "^Offending key" | sed 's/^Offending key in \(.*\):\([0-9]*\)\r$/\1 \2/' | (
  read A B;
  if [ -n "$B" ]; then
	sed "${B}d" $A > $TMPFILE;
	sudo mv $TMPFILE $A;
	[ $? -eq 0 ] && $EXEC
  else exit 1
  fi)
fi

